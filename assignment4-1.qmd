---
title: "Assignment 4: Namit Shrivastava"
format: pdf
editor: visual
---

## Setup

```{r results='hide', message=FALSE, warning=FALSE}
library(caret)
library(randomForest)
library(partykit)
library(pdp)
library(iml)
```

## Data

Here we use data from the UCI Machine Learning repository on drug consumption. The data contains records for 1885 respondents with personality measurements (e.g. Big-5), level of education, age, gender, country of residence and ethnicity as features. In addition, information on the usage of 18 drugs is included.

Source: https://archive.ics.uci.edu/ml/datasets/Drug+consumption+%28quantified%29

```{r}
library(mlforsocialscience)
data(drugs)
```

---

#### 1) Predicting drug usage

**a) Prepare an outcome variable. For this you can choose from the variables on drug consumption and pick one drug (or a combination of drugs) as the prediction objective. The resulting variable should be of class `factor`, but it can have more than two categories if needed.**

```{r}
str(drugs)
# Examining the Cannabis variable which appears to use "CL" categories
table(drugs$Cannabis)

# Creating a meaningful cannabis use outcome variable
drugs$CannabisUse <- factor(
  ifelse(drugs$Cannabis == "CL0", "Non-user",
         ifelse(drugs$Cannabis %in% c("CL1", "CL2", "CL3"), "Occasional user", 
                "Frequent user")),
  levels = c("Non-user", "Occasional user", "Frequent user")
)

# Checking the distribution of the new outcome variable
table(drugs$CannabisUse)
prop.table(table(drugs$CannabisUse)) * 100

# Visualizing the distribution
barplot(table(drugs$CannabisUse), 
        main="Cannabis Use Categories", 
        col=c("skyblue", "lightgreen", "coral"),
        ylim=c(0, max(table(drugs$CannabisUse))*1.2))
```

**b) Next split the data into a training and a test part.**

```{r}
# Set seed for reproducibility
set.seed(9574)

# So creating a stratified partitioning based on the CannabisUse variable
# which ensures balanced distribution of classes in both train and test sets
inTrain <- createDataPartition(drugs$CannabisUse, 
                              p = .8, 
                              list = FALSE, 
                              times = 1)

# Creating training and test datasets
drugs_train <- drugs[inTrain,]
drugs_test <- drugs[-inTrain,]

# Verifying whether the split worked correctly
cat("Training set dimensions:", dim(drugs_train), "\n")
cat("Test set dimensions:", dim(drugs_test), "\n")

# Checking class distribution in both sets to ensure stratification worked
print("Class distribution in training set:")
prop.table(table(drugs_train$CannabisUse)) * 100

print("Class distribution in test set:")
prop.table(table(drugs_test$CannabisUse)) * 100
```

**c) Specify the evaluation method for the `train()` function of `caret` with 10-fold cross-validation.**

```{r}
ctrl <- trainControl(
  method = "cv", # 10-fold cross-validation
  number = 10, # Number of folds
  classProbs = TRUE, # Calculating class probabilities
  summaryFunction = multiClassSummary,  # For multi-class problems
  verboseIter = TRUE,  # Showing progress
  savePredictions = "final" # Saving predictions for ROC curves later
)
```

**d) Specify a grid object for tuning a random forest model.**

```{r}
rf_grid <- expand.grid(
  mtry = c(2, 4, 6, 8) # Number of variables randomly sampled at each split
)
```

**e) Use `train()` from `caret` in order to grow the forest. Do not use any of the other drugs as predictors in this model. Determine the best model based on the tuning results.**

```{r}

```

---

#### 2) Interpreting the model

**a) Find and create a plot of the variable importances. What are you interpretations of this?**

**b) Create some partial dependence plots. What are your interpretations of these plots?**

```{r}

```

**c) Create some ICE plots. What are your interpretations of these plots?**

```{r}

```

**d) What are some possible actions that can be taken using the results of these interpretations?**

---

#### 3) Prediction and Bias

**a) Use `predict()` in order to predict class membership and probabilities in the test set.**

```{r}

```

**b) Evaluate prediction performance based on two or three measures.**

```{r}

```

**c) Look at the differences in performance metrics by gender. Are there any possible biases in the predictions?**

```{r}

```

